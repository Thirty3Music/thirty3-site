<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THIRTY3 — Work</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    :root{
      --muted:#b9c0c2;
      --chip:rgba(255,255,255,.06);
      --chipHover:rgba(255,255,255,.12);
      --line:rgba(255,255,255,.12);
      --bgGlass:rgba(0,0,0,.25);
      --accent:#57e2d6; /* title color */
      --ink:#e7eceb;
    }
    body.work{
      --topbar:60px;
      overflow-y:auto;
      background:#000;
      padding-top:var(--topbar);
    }
    body.work.modal-open{ overflow:hidden; }
    body.work .topbar{ z-index:940; }
    body.work .topbar nav{ z-index:941; }

    /* Hero */
    .wk-hero{ max-width:1100px; margin:48px auto 18px; padding:0 20px; }
    .wk-eyebrow{ color:var(--muted); letter-spacing:.18em; font-size:12px; margin:0 0 8px; text-transform:uppercase; opacity:.8; }
    .wk-title{ font-size:clamp(28px,3.5vw,42px); margin:0 0 10px; letter-spacing:.04em; color:var(--accent); }
    .wk-sub{ color:#dfe4e6; opacity:.85; margin:0 0 22px; line-height:1.5; }

    /* Tabs */
    .wk-tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      border-top:1px solid var(--line); border-bottom:1px solid var(--line);
      padding:10px 0; margin-bottom:22px;
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.06) 0, rgba(255,255,255,.06) 1px, transparent 1px, transparent 42px);
      background-blend-mode:overlay;
    }
    .wk-tab{
      appearance:none; border:1px solid var(--line); background:var(--chip);
      color:#fff; font-size:13px; letter-spacing:.06em; font-weight:600;
      padding:8px 12px; border-radius:4px; cursor:pointer;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .wk-tab[aria-pressed="true"]{ background:var(--chipHover); border-color:#fff; }
    .wk-tab:hover{ transform:translateY(-1px); }

    /* Grid */
    .wk-grid{ max-width:1100px; margin:0 auto 64px; padding:0 20px; display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; }
    @media (max-width:980px){ .wk-grid{ grid-template-columns:repeat(2, 1fr); } }
    @media (max-width:640px){ .wk-grid{ grid-template-columns:1fr; } }

    .wk-card{
      display:flex; flex-direction:column; gap:10px;
      background:var(--bgGlass); border:1px solid var(--line);
      border-radius:12px; overflow:hidden; cursor:pointer;
      transition:transform .14s ease, border-color .14s ease, box-shadow .14s ease;
      backdrop-filter: blur(4px);
    }
    .wk-card:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,.28); box-shadow:0 10px 28px rgba(0,0,0,.35); }

    .wk-thumb{ aspect-ratio:16/10; object-fit:cover; width:100%; display:block; filter:contrast(.98) saturate(.95) brightness(.9); }
    .wk-meta{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px; }
    .wk-kind{ font-size:11px; color:var(--muted); letter-spacing:.16em; text-transform:uppercase; }
    .wk-name{ font-size:15px; letter-spacing:.02em; color:var(--ink); } /* keep light */

    .wk-actions{ display:flex; gap:8px; padding:0 14px 14px; flex-wrap:wrap; }
    .wk-chip{
      border:1px solid var(--line);
      background:var(--chip);
      color:#fff;
      font-size:12px;
      padding:6px 10px;
      border-radius:6px;
      text-decoration:none;
      transition:background .12s ease, border-color .12s ease;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .wk-chip:hover{ background:var(--chipHover); border-color:#fff; }
    .wk-chip:focus-visible{ outline:2px solid rgba(255,255,255,.35); outline-offset:2px; }
    button.wk-chip{ font:inherit; }

    /* Modal */
    .wk-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:calc(var(--topbar,60px) + 16px) 16px 16px;
      box-sizing:border-box;
      background:transparent;
      border:0;
      z-index:930;
      overflow-y:auto;
    }
    .wk-modal::backdrop{ background:transparent; }
    .wk-modal[open]{ display:flex; }
    .wk-scrim{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
    }
    .wk-dialog{
      position:relative;
      z-index:1;
      width:min(960px, calc(100vw - 32px));
      max-height:calc(100vh - (var(--topbar,60px) + 32px));
      background:rgba(8,10,11,.9);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 24px 60px rgba(0,0,0,.55);
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      grid-template-rows:minmax(0,1fr);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    .wk-preview,
    .wk-detail{ min-height:0; }
    .wk-preview{
      background:#0b0f11;
      padding:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:240px;
    }
    .wk-detail{
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      scrollbar-gutter:stable both-edges;
    }
    .wk-detail-top{
      position:sticky;
      top:0;
      margin-bottom:8px;
      padding:6px 0 12px;
      display:flex;
      justify-content:flex-end;
      background:linear-gradient(to bottom, rgba(8,10,11,.95), rgba(8,10,11,.6));
      z-index:2;
    }
    .wk-detail-top::after{
      content:"";
      position:absolute;
      inset:auto 0 -12px;
      height:12px;
      background:linear-gradient(to bottom, rgba(8,10,11,.6), rgba(8,10,11,0));
      pointer-events:none;
    }
    .wk-detail-top > *{ position:relative; z-index:2; }
    .wk-close:focus-visible{ outline:2px solid rgba(255,255,255,.35); outline-offset:2px; }
    .wk-media-frame{
      width:100%;
      max-width:960px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:0;
    }
    .wk-media{
      width:min(100%, 960px);
      aspect-ratio:16/9;
    }
    .wk-media-frame.is-embed,
    .wk-media-frame.is-video{ align-items:stretch; }
    .wk-media-frame.is-video,
    .wk-media-frame.is-video-embed{
      aspect-ratio:16/9;
      width:100%;
      max-height:calc(100vh - (var(--topbar,60px) + 160px));
    }
    .wk-media-frame.is-embed:not(.is-video-embed){
      width:100%;
      max-height:calc(100vh - (var(--topbar,60px) + 160px));
      aspect-ratio:16/9;
    }
    .wk-media-frame iframe,
    .wk-media-frame video{
      width:100%;
      height:100%;
      border:0;
    }
    .wk-media iframe{ width:100%; height:100%; }
    .wk-media-frame.is-video video{ object-fit:contain; }
    .wk-media-frame.is-image{
      width:100%;
      max-height:calc(100vh - (var(--topbar,60px) + 160px));
      aspect-ratio:auto;
    }
    .wk-media-frame.is-image img{
      max-width:100%;
      max-height:calc(100vh - (var(--topbar,60px) + 160px));
      width:auto;
      height:auto;
      object-fit:contain;
      border:0;
    }
    @supports not (aspect-ratio:1){
      .wk-media-frame.is-video,
      .wk-media-frame.is-video-embed{ position:relative; width:100%; max-width:960px; }
      .wk-media-frame.is-video::before,
      .wk-media-frame.is-video-embed::before{
        content:"";
        display:block;
        padding-top:56.25%;
      }
      .wk-media-frame.is-video > *,
      .wk-media-frame.is-video-embed > *{
        position:absolute;
        inset:0;
      }
    }
    @media (max-width:900px){
      .wk-dialog{
        grid-template-columns:1fr;
        grid-template-rows:auto minmax(0,1fr);
      }
    }
    @media (max-width:720px){
      body.work{ --topbar:56px; }
      .wk-modal{ padding:calc(var(--topbar,56px) + 16px) 8px 16px; }
      .wk-dialog{
        width:100%;
        max-height:calc(100vh - (var(--topbar,56px) + 32px));
        border-radius:14px;
      }
      .wk-preview{ padding:0; min-height:0; }
      .wk-detail{ padding:18px; }
      .wk-detail-top{ padding:6px 0 12px; }
    }
    @media (max-width:600px){
      .wk-row .wk-chip, .wk-close{ font-size:11px; padding:6px 10px; }
      .wk-actions{ flex-wrap:wrap; }
    }
    .wk-detail h3{ margin:2px 0 2px; letter-spacing:.02em; color:var(--ink); }
    .wk-detail p{ margin:0; color:#dfe4e6; opacity:.86; line-height:1.5; }
    .wk-detail .wk-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }

    .wk-tracks{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .wk-tracklabel{ font-size:11px; letter-spacing:.16em; text-transform:uppercase; color:var(--muted); margin:0 0 2px; }
    .wk-tracklist{ display:flex; flex-direction:column; gap:8px; }
    .track-row{
      display:flex; align-items:center; gap:12px;
      border:1px solid var(--line); border-radius:10px;
      background:rgba(255,255,255,.03);
      padding:10px; text-align:left;
      font:inherit; color:inherit; cursor:pointer;
      transition:border-color .12s ease, background .12s ease, transform .12s ease;
      appearance:none;
    }
    .track-row:hover{ border-color:rgba(255,255,255,.28); background:rgba(255,255,255,.06); }
    .track-row:focus-visible{ outline:2px solid rgba(255,255,255,.35); outline-offset:2px; }
    .track-row.active{ border-color:#fff; background:rgba(255,255,255,.08); transform:translateY(-1px); }
    .track-row img{ width:52px; height:52px; border-radius:8px; object-fit:cover; flex-shrink:0; }
    .track-row .title{ flex:1; font-size:13px; letter-spacing:.03em; color:var(--ink); }
    .track-row .badge{ font-size:10px; letter-spacing:.12em; text-transform:uppercase; border:1px solid var(--line); border-radius:999px; padding:2px 6px; background:rgba(255,255,255,.08); color:var(--ink); }

    .wk-close{ border:1px solid var(--line); background:var(--chip); color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:13px; margin-left:auto; }
    .wk-close:hover{ background:var(--chipHover); border-color:#fff; }
  </style>
</head>

<body class="work">
  <header class="topbar">
    <nav>
      <a href="https://www.instagram.com/_thirty3_/" target="_blank">INSTAGRAM</a>
      <a href="https://soundcloud.com/thirty_3" target="_blank">SOUNDCLOUD</a>
      <a href="https://www.youtube.com/@thirty3473" target="_blank">YOUTUBE</a>
      <a href="work-test.html">WORK</a>
      <a href="mailto:thirty3contact@gmail.com">CONTACT</a>
    </nav>
  </header>

  <section class="wk-hero">
    <p class="wk-eyebrow">SELECTED</p>
    <h1 class="wk-title">Work</h1>
    <p class="wk-sub">Solo pieces, collaborations and live/visual projects.</p>

    <div class="wk-tabs" role="tablist" aria-label="Work categories">
      <button class="wk-tab" aria-pressed="true" data-filter="all">All</button>
      <button class="wk-tab" aria-pressed="false" data-filter="solo">Solo Projects</button>
      <button class="wk-tab" aria-pressed="false" data-filter="remix">Remixes</button>
      <button class="wk-tab" aria-pressed="false" data-filter="collab">Collabs</button>
      <button class="wk-tab" aria-pressed="false" data-filter="live">Live / AV</button>
    </div>
  </section>

  <section class="wk-grid" id="wkGrid" aria-live="polite"></section>

  <dialog class="wk-modal" id="wkModal">
    <div class="wk-scrim" data-close></div>
      <div class="wk-dialog">
        <div class="wk-preview" id="wkPreview"></div>
        <div class="wk-detail">
          <div class="wk-detail-top">
            <button class="wk-close" data-close type="button">Close</button>
          </div>
          <h3 id="wkTitle">Title</h3>
        <p id="wkDesc"></p>
        <div class="wk-row" id="wkLinks"></div>
        <div class="wk-tracks" id="wkTracks" hidden></div>
      </div>
    </div>
  </dialog>

  <script>
/* =========================================================
   THIRTY3 — Work grid
   ========================================================= */
const PLACEHOLDER = 'image00015.jpeg';

function cleanScUrl(u) {
  try {
    const x = new URL(u);
    x.search = '';
    x.hash = '';
    return x.toString();
  } catch (e) {
    return (u || '').split('?')[0];
  }
}

function scEmbed(u){
  const url = 'https://w.soundcloud.com/player/?url=' +
    encodeURIComponent(cleanScUrl(u)) +
    '&color=%23161616&auto_play=false&hide_related=false&show_comments=false&visual=true';
  return url;
}

const MEMORIES_SET_URL = 'https://soundcloud.com/thirty_3/sets/memories-of-noise';
const MEMORIES_DATA_URL = 'data/memories-of-noise.json';

/* ---------- PROJECTS (manuellt) ---------- */
let PROJECTS = [
  {
    title: "Memories of Noise",
    kind: "solo",
    type: "album",
    thumb: "auto",
    media: { type: "embed", src: scEmbed(MEMORIES_SET_URL) },
    preview: null,
    desc: "Nine-track album exploring electronic, ambient and noise textures. Produced & mixed by THIRTY3.",
    links: [
      { label: "Listen (SoundCloud set)", href: MEMORIES_SET_URL }
    ],
    dataUrl: MEMORIES_DATA_URL,
    setUrl: MEMORIES_SET_URL,
    children: []
  },

  /* ====== SOLO (singlar/EP) ====== */
  {
    title: "The Call Below",
    kind: "solo",
    thumb: "auto",
    media: { type: "embed", src: youtubeEmbed("https://youtu.be/Y_YEgEOXtAM") },
    desc: "Single released on Bandcamp.",
    links: [
      { label: "Listen (SoundCloud)", href: "https://soundcloud.com/thirty_3/the-call-below" },
      { label: "Watch (YouTube)", href: "https://youtu.be/Y_YEgEOXtAM" },
      { label: "View on Bandcamp", href: "https://thirty3.bandcamp.com/track/the-call-below" }
    ]
  },
  {
    title: "Mislay (feat. Lidnesty)",
    kind: "solo",
    thumb: "auto",
    media: { type: "embed", src: youtubeEmbed("https://youtu.be/tV5tmkoVEO0") },
    desc: "From the 'Memories of Noise' series.",
    links: [
      { label: "Listen (SoundCloud)", href: "https://soundcloud.com/thirty_3/mislay-feat-lidnesty" },
      { label: "Watch (YouTube)", href: "https://youtu.be/tV5tmkoVEO0" },
      { label: "View set", href: "https://soundcloud.com/thirty_3/sets/memories-of-noise" }
    ]
  },
  {
    title: "Esper",
    kind: "solo",
    thumb: "auto",
    media: { type: "embed", src: scEmbed("https://soundcloud.com/thirty_3/esper") },
    desc: "",
    links: [
      { label: "Listen (SoundCloud)", href: "https://soundcloud.com/thirty_3/esper" }
    ]
  },
  {
    title: "Two Souls",
    kind: "solo",
    thumb: "auto",
    media: { type: "embed", src: scEmbed("https://soundcloud.com/thirty_3/sets/two-souls") },
    desc: "Two-track single.",
    links: [
      { label: "View on Bandcamp", href: "https://thirty3.bandcamp.com/album/two-souls" }
    ]
  },

  /* ====== REMIXES ====== */
  { title:"southstar – Miss You (Thirty3 Remix)", kind:"remix", thumb:"auto",
    media:{type:"embed", src: scEmbed("https://soundcloud.com/thirty_3/southstar-miss-you-remix-1")},
    desc:"Darker DnB / breakbeat.",
    links:[{label:"Listen (SoundCloud)", href:"https://soundcloud.com/thirty_3/southstar-miss-you-remix-1"}]
  },
  { title:"COBRAH – BRAND NEW BITCH (Thirty3 Remix)", kind:"remix", thumb:"auto",
    media:{type:"embed", src: scEmbed("https://soundcloud.com/thirty_3/brand-new-bitch-thirty3-remix")},
    links:[{label:"Listen (SoundCloud)", href:"https://soundcloud.com/thirty_3/brand-new-bitch-thirty3-remix"}]
  },
  { title:"Bedroom – In My Head (Thirty3 Remix)", kind:"remix", thumb:"auto",
    media:{type:"embed", src: scEmbed("https://soundcloud.com/thirty_3/bedroom-in-my-head-thirty3-remix")},
    links:[{label:"Listen (SoundCloud)", href:"https://soundcloud.com/thirty_3/bedroom-in-my-head-thirty3-remix"}]
  },
  { title:"Yung Lean – Ghost Town (Thirty3 Remix)", kind:"remix", thumb:"auto",
    media:{type:"embed", src: scEmbed("https://soundcloud.com/thirty_3/yung-lean-ghost-town-feat-travis-scott-thirty3-remix")},
    links:[{label:"Listen (SoundCloud)", href:"https://soundcloud.com/thirty_3/yung-lean-ghost-town-feat-travis-scott-thirty3-remix"}]
  },
  { title:"Lykke Li – Possibility (Thirty3 Remix)", kind:"remix", thumb:"auto",
    media:{type:"embed", src: scEmbed("https://soundcloud.com/thirty_3/lykke-li-possibility-thirty3-remix")},
    links:[{label:"Listen (SoundCloud)", href:"https://soundcloud.com/thirty_3/lykke-li-possibility-thirty3-remix"}]
  },
  { title:"Escape (Thirty3 Remix)", kind:"remix", thumb:"auto",
    media:{type:"embed", src: scEmbed("https://soundcloud.com/thirty_3/escape-thirty3-remix")},
    links:[{label:"Listen (SoundCloud)", href:"https://soundcloud.com/thirty_3/escape-thirty3-remix"}]
  },

  /* ====== COLLABS / LIVE ====== */
  {
    title: "Dream, girl — Cora Onori",
    kind: "collab",
    thumb: "auto",
    media: { type: "embed", src: "https://www.youtube.com/embed/A9clscLNVi0?start=8" },
    desc: "Produced by THIRTY3. Directed by Moncef Henaien.",
    links: [
      { label: "Watch (YouTube)", href: "https://www.youtube.com/watch?v=A9clscLNVi0" },
      { label: "Listen (SoundCloud)", href: "https://soundcloud.com/coraonori/dream-girl" }
    ]
  },
  {
    title: "11:59 — Short film",
    kind: "collab",
    thumb: "auto",
    media: { type: "embed", src: "https://player.vimeo.com/video/282178116" },
    desc: "Sound design & score. Field recordings (hometown + London).",
    links: [
      { label: "Project page", href: "https://petterscholander.com/project/1159" },
      { label: "Watch (Vimeo)", href: "https://vimeo.com/282178116" }
    ]
  },
  {
    title: "A short film about us and the environment",
    kind: "collab",
    thumb: "auto",
    media: { type: "embed", src: "https://player.vimeo.com/video/378989999" },
    desc: "Created by Petter Schölander. Music by Thirty3.",
    links: [ { label: "Watch (Vimeo)", href: "https://vimeo.com/378989999" } ]
  },
  {
    title: "N I T E F I S H — Live (Nordberg)",
    kind: "live",
    thumb: "auto",
    media: { type: "embed", src: "https://www.youtube.com/embed/GDiQughTDqI" },
    desc: "Live AV: performance, virtual environment + live-manipulated audio.",
    links: [ { label: "Watch (YouTube)", href: "https://www.youtube.com/watch?v=GDiQughTDqI" } ]
  },
  {
    title: "Barbie Slumlord — N I T E F I S H",
    kind: "collab",
    thumb: "auto",
    media: { type: "embed", src: "https://www.youtube.com/embed/o9cvorFHGos" },
    desc: "Produced · Mixed · Mastered by THIRTY3.",
    links: [ { label: "Watch (YouTube)", href: "https://www.youtube.com/watch?v=o9cvorFHGos" } ]
  },
  {
    title: "Mitsubishi Facelift — N I T E F I S H",
    kind: "collab",
    thumb: "auto",
    scUrl: "https://soundcloud.com/nitefishofficial/mitsubishi-facelift",
    media: { type: "embed", src: scEmbed("https://soundcloud.com/nitefishofficial/mitsubishi-facelift") },
    desc: "Produced · Mixed · Mastered by THIRTY3.",
    links: [
      { label: "Read (Kmag article)", href: "https://kmag.se/2024/06/09/n-i-t-e-f-i-s-h-slapper-singeln-mitsubishi-facelift-fran-kommande-ep/" },
      { label: "Listen (SoundCloud)", href: "https://soundcloud.com/nitefishofficial/mitsubishi-facelift" }
    ]
  },
  {
    title: "Permaculture Heaven — N I T E F I S H (EP)",
    kind: "collab",
    thumb: "auto",
    media: { type:"embed", src: scEmbed("https://soundcloud.com/nitefishofficial/sets/permaculture-heaven-draft-part") },
    desc: "Production (several tracks) · Mix · Master.",
    links: [
      { label: "Listen (SoundCloud playlist)", href: "https://soundcloud.com/nitefishofficial/sets/permaculture-heaven-draft-part" }
    ]
  },
  {
    title: "Spider Plant — Mix (entire release)",
    kind: "collab",
    thumb: "auto",
    media: { type: "embed", src: "https://www.youtube.com/embed/7r2CZbvWSB8?list=OLAK5uy_nbkkukfRBX66iNm3pulXvNM5WEEPa6K38" },
    desc: "Mixing on all tracks.",
    links: [ { label: "Listen (YouTube)", href: "https://www.youtube.com/watch?v=7r2CZbvWSB8&list=OLAK5uy_nbkkukfRBX66iNm3pulXvNM5WEEPa6K38" } ]
  },
  {
    title: "Club Hub — Thirty3, N I T E F I S H",
    kind: "collab",
    thumb: "auto",
    media: { type:"embed", src: scEmbed("https://soundcloud.com/thirty_3/club-hub") },
    desc: "Collaboration single.",
    links: [
      { label: "Listen (SoundCloud)", href:"https://soundcloud.com/thirty_3/club-hub" },
      { label: "View on Bandcamp", href:"https://nitefishofficial.bandcamp.com/track/club-hub" }
    ]
  },
];

/* ---------- auto-preview/thumbnails ---------- */
function youtubeIdFrom(url){
  const m = url.match(/(?:embed\/|v=|youtu\.be\/)([A-Za-z0-9_-]{11})/);
  return m ? m[1] : null;
}

function youtubeEmbed(url){
  const id = youtubeIdFrom(url || '');
  return id ? `https://www.youtube.com/embed/${id}` : (url || '');
}

const scThumbCache = new Map();
const ytThumbCache = new Map();

function buildSoundCloudThumbCandidates(url){
  if (!url) return [];
  const [base, ...rest] = url.split('?');
  const suffix = rest.length ? `?${rest.join('?')}` : '';
  let cleaned = base.replace(/-t\d+x\d+(?=\.(?:jpg|jpeg|png|gif)$)/i, '');
  cleaned = cleaned.replace(/-large(?=\.(?:jpg|jpeg|png|gif)$)/i, '');
  cleaned = cleaned.replace(/-small(?=\.(?:jpg|jpeg|png|gif)$)/i, '');
  cleaned = cleaned.replace(/-crop(?=\.(?:jpg|jpeg|png|gif)$)/i, '');
  const originalVariant = base.replace(/-t\d+x\d+(?=\.(?:jpg|jpeg|png|gif)$)/i, '-original');
  const candidates = [];
  if (cleaned && cleaned !== base) candidates.push(cleaned + suffix);
  if (originalVariant && originalVariant !== base) candidates.push(originalVariant + suffix);
  const original = base + suffix;
  if (!candidates.includes(original)) candidates.push(original);
  return [...new Set(candidates)];
}

function ensureImage(url){
  if (!url) return Promise.reject(new Error('Missing image url'));
  if (typeof Image === 'undefined') return Promise.resolve(url);
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';
    img.onload = () => resolve(url);
    img.onerror = () => reject(new Error('Image failed to load'));
    img.src = url;
  });
}

async function fetchSoundCloudThumb(scUrl){
  const cleanUrl = cleanScUrl(scUrl);
  if (!cleanUrl) return '';
  const cached = scThumbCache.get(cleanUrl);
  if (typeof cached === 'string') return cached;
  if (cached && typeof cached.then === 'function') return cached;
  const promise = (async () => {
    try {
      const res = await fetch(`https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(cleanUrl)}`);
      if (!res.ok) throw new Error('SoundCloud oEmbed failed');
      const data = await res.json();
      const baseThumb = data && data.thumbnail_url ? data.thumbnail_url : '';
      const candidates = buildSoundCloudThumbCandidates(baseThumb);
      let attemptedBase = false;
      let baseFailed = false;
      for (const candidate of candidates){
        const isBase = candidate === baseThumb;
        if (isBase) attemptedBase = true;
        try {
          const confirmed = await ensureImage(candidate);
          if (confirmed){
            scThumbCache.set(cleanUrl, confirmed);
            return confirmed;
          }
        } catch (err) {
          if (isBase) baseFailed = true;
        }
      }
      const fallback = (attemptedBase && baseFailed) ? '' : (baseThumb || '');
      scThumbCache.set(cleanUrl, fallback);
      return fallback;
    } catch (e) {
      scThumbCache.set(cleanUrl, '');
      return '';
    }
  })();
  scThumbCache.set(cleanUrl, promise);
  return promise;
}

async function fetchYouTubeThumb(id){
  if (!id) return '';
  const cached = ytThumbCache.get(id);
  if (typeof cached === 'string') return cached;
  if (cached && typeof cached.then === 'function') return cached;
  const maxRes = `https://img.youtube.com/vi/${id}/maxresdefault.jpg`;
  const high = `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
  if (typeof Image === 'undefined') {
    ytThumbCache.set(id, maxRes);
    return maxRes;
  }
  const promise = new Promise((resolve) => {
    const settle = (value) => {
      ytThumbCache.set(id, value);
      resolve(value);
    };
    const probe = new Image();
    probe.decoding = 'async';
    probe.referrerPolicy = 'no-referrer';
    probe.onload = () => settle(maxRes);
    probe.onerror = () => {
      const fallbackImg = new Image();
      fallbackImg.decoding = 'async';
      fallbackImg.referrerPolicy = 'no-referrer';
      fallbackImg.onload = () => settle(high);
      fallbackImg.onerror = () => settle('');
      fallbackImg.src = high;
    };
    probe.src = maxRes;
  });
  ytThumbCache.set(id, promise);
  return promise;
}

async function fetchYouTubeThumbForUrl(url){
  const id = youtubeIdFrom(url || '');
  if (!id) return '';
  return fetchYouTubeThumb(id);
}

function tryImg(u){
  return new Promise(res => {
    const i = new Image();
    i.onload = () => res(u);
    i.onerror = () => res(null);
    i.src = u;
  });
}

async function resolveThumb(p){
  if (p.thumb && p.thumb !== 'auto') return p.thumb;
  if (!p.media || p.media.type !== 'embed') return PLACEHOLDER;
  const url = p.media.src || '';

  // YouTube
  if (/youtube\.com|youtu\.be/.test(url)) {
    const id = youtubeIdFrom(url);
    if (id) {
      const hi = await tryImg(`https://img.youtube.com/vi/${id}/maxresdefault.jpg`);
      return hi || `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
    }
  }

  // Vimeo
  if (/vimeo\.com/.test(url)) {
    try {
      const vimeoUrl = url.replace('https://player.vimeo.com/video/', 'https://vimeo.com/');
      const o = await fetch(`https://vimeo.com/api/oembed.json?url=${encodeURIComponent(vimeoUrl)}`).then(r=>r.json());
      if (o?.thumbnail_url) return o.thumbnail_url;
    } catch(e){}
  }

  // SoundCloud
  if (/soundcloud\.com/.test(url) || /w\.soundcloud\.com\/player/.test(url)) {
    try {
      let sc = url;
      const q = new URL(url).searchParams.get('url');
      if (q) sc = decodeURIComponent(q);
      const o = await fetch(`https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(sc)}`).then(r=>r.json());
      if (o?.thumbnail_url) {
        return o.thumbnail_url
          .replace('-t300x300', '-t500x500')
          .replace('-large', '-t500x500')
          .replace('-t120x120','-t500x500');
      }
    } catch(e){}
  }

  return PLACEHOLDER;
}

/* ---------- render ---------- */
const grid  = document.getElementById('wkGrid');
const tabs  = [...document.querySelectorAll('.wk-tab')];
let current = 'all';

function createCard(p){
  const card = document.createElement('article');
  card.className = 'wk-card';
  card.setAttribute('tabindex','0');

  const img = document.createElement('img');
  img.className = 'wk-thumb';
  img.alt = p.title;
  img.src = PLACEHOLDER;
  resolveThumb(p).then(u => { img.src = u || PLACEHOLDER; }).catch(()=>{});

  const meta = document.createElement('div'); 
  meta.className = 'wk-meta';
  const left = document.createElement('div');
  const kind = document.createElement('div'); kind.className = 'wk-kind'; kind.textContent = (p.kind || 'solo');
  const name = document.createElement('div'); name.className = 'wk-name'; name.textContent = p.title;
  left.append(kind, name);
  meta.append(left);

  const actions = document.createElement('div');
  actions.className = 'wk-actions';
  (p.links||[]).forEach(l=>{
    if (!l || !l.href || l.showOnCard === false) return;
    const label = typeof l.label === 'string' ? l.label : String(l.label || '');
    const rawHref = typeof l.href === 'string' ? l.href : '';
    const needsClean = /soundcloud/i.test(label) || /soundcloud/i.test(rawHref);
    const href = needsClean ? cleanScUrl(rawHref) : rawHref;
    if (!href) return;
    const a = document.createElement('a');
    a.href = href; a.target = '_blank'; a.rel='noopener';
    a.className = 'wk-chip'; a.textContent = label;
    actions.appendChild(a);
  });

  card.append(img, meta);
  if (actions.childElementCount) card.append(actions);
  card.addEventListener('click', ()=> openModal(p, card));
  card.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      openModal(p, card);
    }
  });

  return card;
}

function passesFilter(p){
  if (current === 'all') return true;
  const kind = (p.kind || 'solo');
  if (current === 'solo') return kind === 'solo';
  return kind === current;
}

function render(){
  grid.innerHTML = '';
  PROJECTS.filter(passesFilter).forEach(p => grid.appendChild(createCard(p)));
}

tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabs.forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    current = btn.dataset.filter;
    render();
  });
});

/* ---------- modal ---------- */
const modal       = document.getElementById('wkModal');
const preview     = document.getElementById('wkPreview');
const titleEl     = document.getElementById('wkTitle');
const descEl      = document.getElementById('wkDesc');
const linksEl     = document.getElementById('wkLinks');
const tracksEl    = document.getElementById('wkTracks');
const closeButton = document.querySelector('.wk-close[data-close]');
let lastTriggerEl = null;

function closeModal(){
  if (!modal.hasAttribute('open')) return;
  modal.removeAttribute('open');
  document.body.classList.remove('modal-open');
  const toFocus = lastTriggerEl;
  lastTriggerEl = null;
  if (toFocus && typeof toFocus.focus === 'function') {
    requestAnimationFrame(()=>{
      try {
        toFocus.focus({ preventScroll: true });
      } catch (err) {
        toFocus.focus();
      }
    });
  }
}

function renderPreviewContent(media, options = {}){
  const fallback = options.fallback || PLACEHOLDER;
  const label = options.title || titleEl.textContent || 'Preview';

  preview.innerHTML = '';

  const frame = document.createElement('div');
  frame.className = 'wk-media-frame wk-media';

  if (!media) {
    frame.classList.add('is-image');
    const img = document.createElement('img');
    img.src = fallback;
    img.alt = label;
    frame.appendChild(img);
    preview.appendChild(frame);
    return;
  }

  if (media.type === 'video') {
    frame.classList.add('is-video');
    const v = document.createElement('video');
    v.src = media.src;
    v.controls = true;
    v.playsInline = true;
    v.autoplay = Boolean(media.autoplay);
    v.title = label;
    frame.appendChild(v);
    preview.appendChild(frame);
    return;
  }

  if (media.type === 'embed') {
    const src = String(media.src || '');
    const isVideoEmbed = /(?:youtube|youtu\.be|vimeo)/i.test(src);
    frame.classList.add('is-embed');
    if (isVideoEmbed) frame.classList.add('is-video-embed');
    const iframe = document.createElement('iframe');
    iframe.src = media.src;
    iframe.allow = media.allow || 'autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share';
    iframe.referrerPolicy = media.referrerPolicy || 'strict-origin-when-cross-origin';
    iframe.loading = 'lazy';
    iframe.title = label;
    if (isVideoEmbed) iframe.allowFullscreen = true;
    frame.appendChild(iframe);
    preview.appendChild(frame);
    return;
  }

  frame.classList.add('is-image');
  const img = document.createElement('img');
  img.src = media.src || fallback;
  img.alt = label;
  frame.appendChild(img);
  preview.appendChild(frame);
}

function openModal(p, triggerEl){
  const candidate = triggerEl || document.activeElement;
  lastTriggerEl = (candidate && typeof candidate.focus === 'function') ? candidate : null;

  titleEl.textContent = p.title;
  const desc = (p.desc || '').trim();
  if (desc) {
    descEl.textContent = desc;
    descEl.hidden = false;
  } else {
    descEl.textContent = '';
    descEl.hidden = true;
  }
  linksEl.innerHTML   = '';

  const trackButtons = new Map();
  let activeTrackButton = null;

  function highlightTrack(title){
    const key = (title || '').trim().toLowerCase();
    const entry = trackButtons.get(key);
    if (!entry) return;
    if (activeTrackButton && activeTrackButton !== entry.button) {
      activeTrackButton.classList.remove('active');
    }
    activeTrackButton = entry.button;
    activeTrackButton.classList.add('active');
  }

  function setPreview(media, title, options = {}){
    let fallbackSrc = options.fallback;
    if (!fallbackSrc && p.preview?.type === 'image' && p.preview?.src) fallbackSrc = p.preview.src;
    if (!fallbackSrc && p.thumb && p.thumb !== 'auto') fallbackSrc = p.thumb;
    renderPreviewContent(media, { title, fallback: fallbackSrc || PLACEHOLDER });
  }

  function createLinkControl(link){
    if (!link) return null;
    if (link.href){
      const label = typeof link.label === 'string' ? link.label : String(link.label || '');
      const rawHref = typeof link.href === 'string' ? link.href : '';
      const needsClean = /soundcloud/i.test(label) || /soundcloud/i.test(rawHref);
      const href = needsClean ? cleanScUrl(rawHref) : rawHref;
      if (!href) return null;
      const a = document.createElement('a');
      a.href = href;
      a.target = '_blank';
      a.rel = 'noopener';
      a.className = 'wk-chip';
      a.textContent = label;
      return a;
    }
    if (link.action === 'preview' && link.media){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'wk-chip';
      btn.textContent = link.label;
      btn.addEventListener('click', ()=>{
        if (link.trackTitle) highlightTrack(link.trackTitle);
        setPreview(link.media, link.trackTitle || link.label, { fallback: link.thumb || p.thumb });
      });
      return btn;
    }
    return null;
  }

  (p.links||[]).forEach(link => {
    const el = createLinkControl(link);
    if (el) linksEl.appendChild(el);
  });
  linksEl.hidden = !linksEl.childElementCount;

  const defaultPreview = p.preview || p.media || ((p.thumb && p.thumb !== 'auto') ? { type: 'image', src: p.thumb } : null);
  setPreview(defaultPreview, p.title);

  // album tracks (if any)
  tracksEl.innerHTML = '';
  tracksEl.scrollTop = 0;
  if (Array.isArray(p.children) && p.children.length){
    tracksEl.hidden = false;
    const label = document.createElement('p');
    label.className = 'wk-tracklabel';
    label.textContent = 'Tracklist';
    const list = document.createElement('div');
    list.className = 'wk-tracklist';
    tracksEl.append(label, list);

    p.children.forEach((t)=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'track-row';
      const img = document.createElement('img');
      img.src = t.thumb || PLACEHOLDER;
      img.alt = `${t.title || 'Track'} artwork`;
      const name = document.createElement('span');
      name.className = 'title';
      name.textContent = t.title || 'Untitled';
      btn.append(img, name);
      if (t.youtubeUrl){
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = 'MV';
        btn.appendChild(badge);
      }
      list.appendChild(btn);

      const key = (t.title || '').trim().toLowerCase();
      trackButtons.set(key, { button: btn, track: t });

      btn.addEventListener('click', ()=>{
        highlightTrack(t.title);
        if (t.media){
          setPreview(t.media, t.title, { fallback: t.thumb });
        } else {
          setPreview(null, t.title, { fallback: t.thumb });
        }
      });
    });
  } else {
    tracksEl.hidden = true;
  }

  modal.scrollTop = 0;
  modal.setAttribute('open','');
  document.body.classList.add('modal-open');

  const focusTarget = closeButton;
  if (focusTarget && typeof focusTarget.focus === 'function') {
    requestAnimationFrame(()=>{
      try {
        focusTarget.focus({ preventScroll: true });
      } catch (err) {
        focusTarget.focus();
      }
    });
  }
}
modal.addEventListener('click', (e)=>{
  if (e.target instanceof HTMLElement && e.target.hasAttribute('data-close')) {
    e.preventDefault();
    closeModal();
  }
});
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape' && modal.hasAttribute('open')) {
    e.preventDefault();
    closeModal();
  }
});

/* ---------- (optional) merge auto-data om du kör scripts/sync.js ---------- */
async function loadAutoProjects() {
  try {
    const res = await fetch('data/auto-projects.json?v=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('No auto-projects.json');
    const auto = await res.json();

    const seen = new Set();
    function dedupe(list){
      const out = [];
      for (const p of list){
        const k = (p.title||'').trim().toLowerCase();
        if (!k || seen.has(k)) continue;
        seen.add(k); out.push(p);
      }
      return out;
    }
    PROJECTS = dedupe([ ...auto, ...PROJECTS ]);
  } catch (err) {}
}

async function loadMemoriesAlbum(){
  const album = PROJECTS.find(p => p.dataUrl === MEMORIES_DATA_URL);
  if (!album) return;

  album.setUrl = cleanScUrl(album.setUrl || MEMORIES_SET_URL);

  try {
    const res = await fetch(`${album.dataUrl}?v=${Date.now()}`, { cache: 'no-store' });
    if (!res.ok) throw new Error('memories-of-noise.json missing');
    const list = await res.json();

    const tracks = await Promise.all((list || []).map(async (track) => {
      const scUrl = cleanScUrl(track.scUrl || '');
      const youtubeUrl = track.youtubeUrl || '';
      let thumb = track.thumb || '';
      if (!thumb && scUrl) thumb = await fetchSoundCloudThumb(scUrl);
      if (!thumb && youtubeUrl) thumb = await fetchYouTubeThumbForUrl(youtubeUrl);
      const primaryMedia = scUrl ? { type: 'embed', src: scEmbed(scUrl) } : (youtubeUrl ? { type: 'embed', src: youtubeEmbed(youtubeUrl) } : null);
      const secondaryMedia = (scUrl && youtubeUrl) ? { type: 'embed', src: youtubeEmbed(youtubeUrl) } : null;
      return {
        title: track.title || 'Untitled',
        thumb: thumb || PLACEHOLDER,
        scUrl,
        youtubeUrl,
        media: primaryMedia,
        altMedia: secondaryMedia,
      };
    }));

    album.children = tracks;

    const coverSource = album.setUrl || MEMORIES_SET_URL;
    const cover = (coverSource ? await fetchSoundCloudThumb(coverSource) : '') || tracks[0]?.thumb;
    if (cover) {
      album.thumb = cover;
      album.preview = { type: 'image', src: cover };
    }

    if (!album.media && album.setUrl) {
      album.media = { type: 'embed', src: scEmbed(album.setUrl) };
    }

    const mvTrack = tracks.find(t => t.youtubeUrl);
    if (mvTrack) {
      const hasMvButton = (album.links || []).some(l => (l.label || '').toLowerCase().includes('watch'));
      if (!hasMvButton) {
        album.links = [...(album.links || []), {
          label: 'Watch MV',
          action: 'preview',
          media: { type: 'embed', src: youtubeEmbed(mvTrack.youtubeUrl) },
          trackTitle: mvTrack.title,
          showOnCard: false,
        }];
      }
    }
  } catch (err) {
    console.warn('Memories of Noise data failed to load', err);
  }
}

(async function boot(){
  await Promise.all([
    loadAutoProjects(),
    loadMemoriesAlbum()
  ]);
  render();
})();
  </script>
</body>
</html>
